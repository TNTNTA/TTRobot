From b410444f938e08967037eaafc86e7a5a27daad2d Mon Sep 17 00:00:00 2001
From: Tao Tang <15642339119@163.com>
Date: Sat, 14 Jan 2023 16:09:27 +0800
Subject: [PATCH] [TT] modify uboot config && support lcd display

---
 arch/arm/dts/stm32mp157d-robot.dts  |  20 +++++-
 arch/arm/dts/stm32mp157d-robot.dtsi | 101 ++++++++++------------------
 configs/stm32mp15_trusted_defconfig |   5 +-
 drivers/video/stm32/stm32_ltdc.c    |  43 +++++++++++-
 include/configs/stm32mp1.h          |   3 +
 5 files changed, 101 insertions(+), 71 deletions(-)

diff --git a/arch/arm/dts/stm32mp157d-robot.dts b/arch/arm/dts/stm32mp157d-robot.dts
index 1878ea658c..91e687f6dc 100644
--- a/arch/arm/dts/stm32mp157d-robot.dts
+++ b/arch/arm/dts/stm32mp157d-robot.dts
@@ -12,8 +12,8 @@
 #include "stm32mp157d-robot.dtsi"
 
 / {
-	model = "STMicroelectronics STM32MP157D TT Robot board";
-	compatible = "st,stm32mp157d-ed1", "st,stm32mp157";
+	model = "STMicroelectronics STM32MP157D TT Robot board V2.2";
+	compatible = "st,stm32mp157d-robot", "st,stm32mp157";
 
 	chosen {
 		stdout-path = "serial0:115200n8";
@@ -31,3 +31,19 @@
 	contiguous-area = <&gpu_reserved>;
 	status = "okay";
 };
+
+&ltdc {
+	status = "okay";
+
+	port {
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		ltdc_ep0_out: endpoint@0 {
+			reg = <0>;
+			remote-endpoint = <&panel_in_rgb>;
+		};
+	};
+};
+
+
diff --git a/arch/arm/dts/stm32mp157d-robot.dtsi b/arch/arm/dts/stm32mp157d-robot.dtsi
index dd03b5b02f..8b19bfed0e 100644
--- a/arch/arm/dts/stm32mp157d-robot.dtsi
+++ b/arch/arm/dts/stm32mp157d-robot.dtsi
@@ -130,6 +130,30 @@
 		regulator-max-microvolt = <5000000>;
 		regulator-always-on;
 	};
+
+	panel_backlight: panel-backlight {
+		compatible = "gpio-backlight";
+		gpios = <&gpioe 15 GPIO_ACTIVE_HIGH>;
+		default-on;
+		status = "okay";
+	};
+
+	panel_rgb: panel-rgb {
+		compatible = "simple-panel";
+		// pinctrl-names = "default", "sleep";
+		pinctrl-names = "default";
+		pinctrl-0 = <&ltdc_pins_b>; 
+		// pinctrl-1 = <&ltdc_pins_sleep_b>;
+		backlight = <&panel_backlight>;
+		status = "okay";
+
+		port {
+			panel_in_rgb: endpoint {
+				remote-endpoint = <&ltdc_ep0_out>;
+			};
+		};
+	};
+
 };
 
 &cpu0{
@@ -250,18 +274,18 @@
 	status = "okay";
 };
 
-&usbotg_hs {
-	phys = <&usbphyc_port1 0>;
-	phy-names = "usb2-phy";
-	usb-role-switch;
-	status = "okay";
+// &usbotg_hs {
+// 	phys = <&usbphyc_port1 0>;
+// 	phy-names = "usb2-phy";
+// 	usb-role-switch;
+// 	status = "okay";
 
-	port {
-		usbotg_hs_ep: endpoint {
-			remote-endpoint = <&con_usbotg_hs_ep>;
-		};
-	};
-};
+// 	port {
+// 		usbotg_hs_ep: endpoint {
+// 			remote-endpoint = <&con_usbotg_hs_ep>;
+// 		};
+// 	};
+// };
 
 &usbphyc {
 	status = "okay";
@@ -274,58 +298,3 @@
 &usbphyc_port1 {
 	phy-supply = <&vdd_usb>;
 };
-
-&ethernet0 {
-	status = "okay";
-	pinctrl-0 = <&ethernet0_rgmii_pins_a>;
-	pinctrl-1 = <&ethernet0_rgmii_pins_sleep_a>;
-	pinctrl-names = "default", "sleep";
-	phy-mode = "rgmii-id";
-	max-speed = <1000>;
-	phy-handle = <&phy0>;
-
-	mdio0 {
-		#address-cells = <1>;
-		#size-cells = <0>;
-		compatible = "snps,dwmac-mdio";
-		phy0: ethernet-phy@0 {
-			reg = <0>;
-		};
-	};
-};
-
-
-&i2c1 {
-	pinctrl-names = "default", "sleep";
-	pinctrl-0 = <&i2c1_pins_b>;
-	pinctrl-1 = <&i2c1_pins_sleep_b>;
-	i2c-scl-rising-time-ns = <100>;
-	i2c-scl-falling-time-ns = <7>;
-	status = "okay";
-	/delete-property/dmas;
-	/delete-property/dma-names;
-
-	stusb1600@28 {
-		compatible = "st,stusb1600";
-		reg = <0x28>;
-		interrupts = <2 IRQ_TYPE_EDGE_FALLING>;
-		interrupt-parent = <&gpiog>;
-		pinctrl-names = "default";
-		pinctrl-0 = <&stusb1600_pins_a>;
-		status = "okay";
-		vdd-supply = <&vin>;
-
-		connector {
-			compatible = "usb-c-connector";
-			label = "USB-C";
-			power-role = "dual";
-			power-opmode = "default";
-
-			port {
-				con_usbotg_hs_ep: endpoint {
-					remote-endpoint = <&usbotg_hs_ep>;
-				};
-			};
-		};
-	};
-};
\ No newline at end of file
diff --git a/configs/stm32mp15_trusted_defconfig b/configs/stm32mp15_trusted_defconfig
index 2161ccbefa..9a0495a048 100644
--- a/configs/stm32mp15_trusted_defconfig
+++ b/configs/stm32mp15_trusted_defconfig
@@ -9,13 +9,13 @@ CONFIG_TARGET_ST_STM32MP15x=y
 CONFIG_CMD_STM32PROG=y
 CONFIG_TYPEC_STUSB160X=y
 CONFIG_ENV_OFFSET_REDUND=0x4C0000
-CONFIG_DEFAULT_DEVICE_TREE="stm32mp157c-ev1"
+CONFIG_DEFAULT_DEVICE_TREE="stm32mp157d-robot"
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_FIT=y
 CONFIG_BOOTDELAY=1
 CONFIG_BOOTCOMMAND="run bootcmd_stm32mp"
 CONFIG_FDT_SIMPLEFB=y
-CONFIG_SYS_PROMPT="STM32MP> "
+CONFIG_SYS_PROMPT="TTRobot> "
 CONFIG_CMD_ADTIMG=y
 # CONFIG_CMD_ELF is not set
 CONFIG_CMD_ERASEENV=y
@@ -141,3 +141,4 @@ CONFIG_WDT_STM32MP=y
 CONFIG_ERRNO_STR=y
 CONFIG_FDT_FIXUP_PARTITIONS=y
 CONFIG_LMB_RESERVED_REGIONS=16
+CONFIG_STM32MP15x_STM32IMAGE=y
diff --git a/drivers/video/stm32/stm32_ltdc.c b/drivers/video/stm32/stm32_ltdc.c
index 2f3427a32e..fe36c6d87a 100644
--- a/drivers/video/stm32/stm32_ltdc.c
+++ b/drivers/video/stm32/stm32_ltdc.c
@@ -154,6 +154,46 @@ enum stm32_ltdc_pix_fmt {
 	PF_AL88
 };
 
+#ifdef TT_ROBOT_LCD_4_800_480
+static const struct display_timing timing_param_4_800_480 = {
+	.pixelclock = {.min = 33300000, .typ = 33300000, .max = 33300000,},
+	.hactive = {.min = 800, .typ = 800, .max = 800,},
+	.hfront_porch = {.min = 40, .typ = 40, .max = 40,},
+	.hback_porch = {.min = 88, .typ = 88, .max = 88,},
+	.hsync_len = {.min = 48, .typ = 48, .max = 48,},
+	.vactive = {.min = 480, .typ = 480, .max = 480,},
+	.vfront_porch = {.min = 13, .typ = 13, .max = 13,},
+	.vback_porch = {.min = 32, .typ = 32, .max = 32,},
+	.vsync_len = {.min = 3, .typ = 3, .max = 3,},
+};
+
+static int robot_panel_get_display_timing(
+                                        struct display_timing *timings){
+        memcpy(timings, &timing_param_4_800_480, sizeof(*timings));
+        return 0;
+};
+#endif
+
+#ifdef TT_ROBOT_LCD_7_800_480
+static const struct display_timing timing_param_7_800_480 = {
+	.pixelclock = {.min = 33300000, .typ = 33300000, .max = 33300000,},
+	.hactive = {.min = 800, .typ = 800, .max = 800,},
+	.hfront_porch = {.min = 210, .typ = 210, .max = 210,},
+	.hback_porch = {.min = 46, .typ = 46, .max = 46,},
+	.hsync_len = {.min = 2, .typ = 2, .max = 2,},
+	.vactive = {.min = 480, .typ = 480, .max = 480,},
+	.vfront_porch = {.min = 22, .typ = 22, .max = 22,},
+	.vback_porch = {.min = 23, .typ = 23, .max = 23,},
+	.vsync_len = {.min = 2, .typ = 2, .max = 2,},
+};
+
+static int robot_panel_get_display_timing(
+                                        struct display_timing *timings){
+        memcpy(timings, &timing_param_7_800_480, sizeof(*timings));
+        return 0;
+};
+#endif
+
 /* TODO add more color format support */
 static u32 stm32_ltdc_get_pixel_format(enum video_log2_bpp l2bpp)
 {
@@ -364,7 +404,8 @@ static int stm32_ltdc_probe(struct udevice *dev)
 		return ret;
 	}
 
-	ret = panel_get_display_timing(panel, &timings);
+	//ret = panel_get_display_timing(panel, &timings);
+	ret = robot_panel_get_display_timing(&timings);
 	if (ret) {
 		ret = fdtdec_decode_display_timing(gd->fdt_blob,
 						   dev_of_offset(panel),
diff --git a/include/configs/stm32mp1.h b/include/configs/stm32mp1.h
index 72424abb8b..302fd3513b 100644
--- a/include/configs/stm32mp1.h
+++ b/include/configs/stm32mp1.h
@@ -82,6 +82,7 @@
 #define CONFIG_BMP_32BPP
 #endif
 
+#define TT_ROBOT_LCD_4_800_480
 /*****************************************************************************/
 #ifdef CONFIG_DISTRO_DEFAULTS
 /*****************************************************************************/
@@ -164,4 +165,6 @@
 #endif /* ifndef CONFIG_SPL_BUILD */
 #endif /* ifdef CONFIG_DISTRO_DEFAULTS*/
 
+//#define CONFIG_CMD_BOOTD
+
 #endif /* __CONFIG_H */
